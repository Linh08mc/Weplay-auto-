package com.you.weplayauto;

import android.accessibilityservice.AccessibilityServiceInfo;
import android.app.Activity;
import android.content.Context;
import android.content.Intent;
import android.content.SharedPreferences;
import android.media.projection.MediaProjectionManager;
import android.net.Uri;
import android.os.Build;
import android.os.Bundle;
import android.provider.Settings;
import android.util.Log;
import android.view.accessibility.AccessibilityManager;
import android.widget.Button;
import android.widget.EditText;
import android.widget.Switch;
import android.widget.TextView;
import android.widget.Toast;

import androidx.annotation.Nullable;
import androidx.appcompat.app.AppCompatActivity;

import java.util.List;

/**
 * MainActivity: UI ch√≠nh ƒë·ªÉ qu·∫£n l√Ω:
 * - b·∫≠t/t·∫Øt Accessibility (m·ªü setting)
 * - b·∫≠t n√∫t n·ªïi (FloatingButtonService) (y√™u c·∫ßu overlay)
 * - b·∫≠t ghi m√†n h√¨nh (y√™u c·∫ßu MediaProjection permission)
 * - c·∫•u h√¨nh Webhook Discord (l∆∞u v√†o SharedPreferences)
 *
 * Target/compile SDK = 29 (Android 10)
 */
public class MainActivity extends AppCompatActivity {

    private static final int REQUEST_OVERLAY_PERMISSION = 1234;
    private static final int REQUEST_SCREEN_CAPTURE = 100;
    private static final String PREFS_NAME = "WePlayAutoPrefs";
    private static final String WEBHOOK_KEY = "webhook_url";
    private static final String DEFAULT_WEBHOOK = "YOUR_DEFAULT_WEBHOOK";

    private Switch serviceSwitch;
    private TextView statusText;
    private Button btnFloating, btnCapture, btnSaveWebhook;
    private EditText edtWebhook;
    private SharedPreferences prefs;
    private AccessibilityManager accessibilityManager;

    @Override
    protected void onCreate(@Nullable Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        // Activity layout: ƒë·∫£m b·∫£o b·∫°n c√≥ layout t∆∞∆°ng ·ª©ng (activity_main.xml)
        setContentView(R.layout.activity_main);

        prefs = getSharedPreferences(PREFS_NAME, MODE_PRIVATE);
        accessibilityManager = (AccessibilityManager) getSystemService(Context.ACCESSIBILITY_SERVICE);

        serviceSwitch = findViewById(R.id.serviceSwitch);
        statusText = findViewById(R.id.statusText);
        btnFloating = findViewById(R.id.btnStartFloating);
        btnCapture = findViewById(R.id.btnStartCapture);
        btnSaveWebhook = findViewById(R.id.btnSaveWebhook);
        edtWebhook = findViewById(R.id.edtWebhook);

        // load webhook
        String saved = prefs.getString(WEBHOOK_KEY, DEFAULT_WEBHOOK);
        edtWebhook.setText(saved);

        updateServiceStatus();

        // listeners
        serviceSwitch.setOnCheckedChangeListener((buttonView, isChecked) -> {
            // M·ªü setting Accessibility ƒë·ªÉ ng∆∞·ªùi d√πng b·∫≠t/t·∫Øt
            startActivity(new Intent(Settings.ACTION_ACCESSIBILITY_SETTINGS));
            Toast.makeText(this, "Vui l√≤ng b·∫≠t/t·∫Øt WePlay Auto trong Tr·ª£ nƒÉng", Toast.LENGTH_LONG).show();
        });

        btnFloating.setOnClickListener(v -> requestOverlayIfNeeded());
        btnCapture.setOnClickListener(v -> startScreenCaptureFlow());
        btnSaveWebhook.setOnClickListener(v -> saveWebhook());
    }

    private void requestOverlayIfNeeded() {
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M && !Settings.canDrawOverlays(this)) {
            Toast.makeText(this, "Vui l√≤ng c·∫•p quy·ªÅn hi·ªÉn th·ªã tr√™n ·ª©ng d·ª•ng kh√°c", Toast.LENGTH_LONG).show();
            Intent intent = new Intent(Settings.ACTION_MANAGE_OVERLAY_PERMISSION,
                    Uri.parse("package:" + getPackageName()));
            startActivityForResult(intent, REQUEST_OVERLAY_PERMISSION);
        } else {
            Intent i = new Intent(this, FloatingButtonService.class);
            startService(i);
            Toast.makeText(this, "‚úÖ N√∫t n·ªïi ƒë√£ b·∫≠t", Toast.LENGTH_SHORT).show();
        }
    }

    private void startScreenCaptureFlow() {
        String webhook = edtWebhook.getText().toString().trim();
        if (webhook.isEmpty() || !webhook.startsWith("https://")) {
            Toast.makeText(this, "Vui l√≤ng nh·∫≠p Webhook h·ª£p l·ªá tr∆∞·ªõc", Toast.LENGTH_SHORT).show();
            return;
        }
        // L∆∞u webhook t·∫°m ƒë·ªÉ service d√πng n·∫øu c·∫ßn
        prefs.edit().putString(WEBHOOK_KEY, webhook).apply();

        // g·ªçi MediaProjection permission
        MediaProjectionManager mgr = (MediaProjectionManager) getSystemService(Context.MEDIA_PROJECTION_SERVICE);
        Intent captureIntent = mgr.createScreenCaptureIntent();
        startActivityForResult(captureIntent, REQUEST_SCREEN_CAPTURE);
    }

    private void saveWebhook() {
        String url = edtWebhook.getText().toString().trim();
        if (url.isEmpty() || !url.startsWith("https://discord.com/api/webhooks/")) {
            Toast.makeText(this, "URL kh√¥ng h·ª£p l·ªá. Ph·∫£i b·∫Øt ƒë·∫ßu b·∫±ng https://discord.com/api/webhooks/", Toast.LENGTH_LONG).show();
            return;
        }
        prefs.edit().putString(WEBHOOK_KEY, url).apply();
        Toast.makeText(this, "‚úÖ ƒê√£ l∆∞u Webhook", Toast.LENGTH_SHORT).show();
    }

    private void updateServiceStatus() {
        boolean enabled = false;
        try {
            List<AccessibilityServiceInfo> list = accessibilityManager.getEnabledAccessibilityServiceList(AccessibilityServiceInfo.FEEDBACK_ALL_MASK);
            for (AccessibilityServiceInfo info : list) {
                if (info.getId().contains(getPackageName())) {
                    enabled = true;
                    break;
                }
            }
        } catch (Exception ignored) {}
        serviceSwitch.setChecked(enabled);
        statusText.setText(enabled ? "‚úì Service ƒëang ho·∫°t ƒë·ªông" : "‚úó Service ch∆∞a b·∫≠t");
    }

    @Override
    protected void onActivityResult(int requestCode, int resultCode, @Nullable Intent data) {
        super.onActivityResult(requestCode, resultCode, data);
        if (requestCode == REQUEST_OVERLAY_PERMISSION) {
            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M && Settings.canDrawOverlays(this)) {
                Intent i = new Intent(this, FloatingButtonService.class);
                startService(i);
                Toast.makeText(this, "‚úÖ ƒê√£ c·∫•p quy·ªÅn overlay v√† b·∫≠t n√∫t n·ªïi", Toast.LENGTH_SHORT).show();
            } else {
                Toast.makeText(this, "‚ùå C·∫ßn c·∫•p ph√©p overlay ƒë·ªÉ b·∫≠t n√∫t n·ªïi", Toast.LENGTH_LONG).show();
            }
            return;
        }

        if (requestCode == REQUEST_SCREEN_CAPTURE) {
            if (resultCode == Activity.RESULT_OK && data != null) {
                // G·ª≠i resultCode + data v√†o service. B·∫ÆT BU·ªòC d√πng startForegroundService tr√™n API>=26
                Intent i = new Intent(this, ScreenCaptureService.class);
                i.putExtra("resultCode", resultCode);
                i.putExtra("data", data);
                // truy·ªÅn webhook ƒë√£ l∆∞u
                i.putExtra("webhook_url", prefs.getString(WEBHOOK_KEY, DEFAULT_WEBHOOK));
                if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                    startForegroundService(i);
                } else {
                    startService(i);
                }
                Toast.makeText(this, "üé• ƒêang kh·ªüi ƒë·ªông ghi m√†n h√¨nh...", Toast.LENGTH_SHORT).show();
            } else {
                Toast.makeText(this, "‚ùå Ng∆∞·ªùi d√πng ƒë√£ t·ª´ ch·ªëi quy·ªÅn ghi m√†n h√¨nh", Toast.LENGTH_SHORT).show();
            }
        }
    }
}